<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon - Solo's Strange Journey</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            color: #333;
            overflow-x: hidden;
            --header-height: 50px;
        }

        #book {
            display: flex;
            max-width: 100vw;
            margin: 0;
            padding: 0;
            background: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        #navigation {
            list-style-type: none;
            margin: 0;
            width: 250px;
            padding: 20px;
            border-right: 2px solid #3498db;
            background-color: #fff;
            height: calc(100vh - 40px - var(--header-height));
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: var(--header-height);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        #navigation.show {
            transform: translateX(0);
        }

        #navigation ul {
            padding: 0;
            margin: 0;
        }

        #navigation li {
            list-style-type: none;
            margin: 10px 0;
        }

        #navigation a {
            text-decoration: none;
            color: #3498db;
            display: block;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        #navigation a:hover {
            background-color: #ecf0f1;
        }

        .highlight {
            background-color: #bbdfff;
            border-radius: 5px;
        }

        #content {
            flex: 1;
            padding: 40px;
            padding-top: 10px;
            min-height: calc(100vh - 50px - var(--header-height));
            background-color: #fff;
            margin-left: 280px;
            margin-top: var(--header-height);
            transition: margin-left 0.3s ease;
        }
		
		/* Styles for paragraphs inside the content area */
        #content p {
            margin: 1em 0;
            line-height: 1.6;
            font-size: 1.1em;
            color: #333;
            font-family: Arial, sans-serif;
            text-align: justify;
            padding: 0 10px;
        }

        #content.shift {
            margin-left: 0;
        }

        #bookTitle {
            flex-grow: 1;
            text-align: center;
            margin: auto 0;
            color: #ebebeb;
        }

        #header-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100vw - 20px);
            height: var(--header-height);
            z-index: 1000;
            padding: 0 10px;
            background-color: #333;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s ease;
        }

        /* When the header is hidden */
        .header-hidden #header-bar {
            transform: translateY(-100%);
            /* Moves header out of view */
        }

        .header-hidden #navigation {
            top: 0;
            /* Adjusts navigator to top */
            height: calc(100vh - 40px);
            /* Expands navigator to full height */
        }

        .header-hidden #content {
            margin-top: 0;
            /* Moves content to the top */
            min-height: calc(100vh - 50px);
        }

        #patreon-username {
            margin-right: 10px;
            font-weight: bold;
            font-size: 16px;
        }

        #patreon-section {
            display: flex;
            align-items: center;
        }

        #toggleNav, #patreon-login, #patreon-logout {
            background-color: #ff424d;
            border: none;
            color: white;
            padding: 10px;
            cursor: pointer;
            font-size: 16px;
        }

        @media screen and (max-device-width: 768px) {
            #toggleNav { display: none; }
            #content { margin-left: 0; padding: 10px; }
            body { --header-height: 80px; }
            #bookTitle { font-size: 20px; }
        }
    </style>
    <script>
		// The file to load at startup. You can change this in the future.
		let navigationFile = "PSSJ_navigation.html";

		// Function to load navigation from an external HTML file
		function loadNavigation(file) {
			fetch(file)
				.then(response => {
					if (!response.ok) {
						throw new Error('Failed to load navigation');
					}
					return response.text();
				})
				.then(data => {
					document.getElementById('navigation').innerHTML = data;
				})
				.catch(error => console.error('Error loading navigation:', error));
		}

		// Load the initial navigation file
		loadNavigation(navigationFile);
		
		function loadContent(url) {
			if (!window.SUPPORTER) return;

			fetch(url)
				.then(response => {
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					return response.text();
				})
				.then(data => {
					document.getElementById('content').innerHTML = data;

					// Store the SELECTED_BOOK and SELECTED_CHAPTER in localStorage
					window.SELECTED_BOOK = "PSSJ"; // Set the book name here
					window.SELECTED_CHAPTER = url; // Set the chapter based on the URL
					localStorage.setItem('SELECTED_BOOK', window.SELECTED_BOOK);
					localStorage.setItem('SELECTED_CHAPTER', window.SELECTED_CHAPTER);
				})
				.catch(error => console.error('Error loading content:', error));
		}
		
		// Check localStorage on startup
		window.addEventListener('load', () => {
			loadContent('homepage.html');
			
			const selectedBook = localStorage.getItem('SELECTED_BOOK');
			const selectedChapter = localStorage.getItem('SELECTED_CHAPTER');

			// Set the SELECTED_BOOK and SELECTED_CHAPTER if they exist in localStorage
			if (selectedBook) {
				window.SELECTED_BOOK = selectedBook;
			}
			if (selectedChapter) {
				window.SELECTED_CHAPTER = selectedChapter;
			}

			// If the user is not a supporter, clear the localStorage variables
			if (!window.SUPPORTER) {
				localStorage.removeItem('SELECTED_BOOK');
				localStorage.removeItem('SELECTED_CHAPTER');
			} else {
				loadContent(selectedChapter);
			}
		});
	</script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
			// navigator highlighting
            document.querySelectorAll('#navigation a').forEach(function (link) {
                link.addEventListener('click', function () {
                    document.querySelectorAll('#navigation li').forEach(li => li.classList.remove('highlight'));
                    this.closest('li').classList.add('highlight');
                });
            });

            const toggleNav = document.getElementById('toggleNav');
            const nav = document.getElementById('navigation');
            const content = document.getElementById('content');
            
            toggleNav.addEventListener('click', () => {
                nav.classList.toggle('show');
                content.classList.toggle('shift');
            });

            // Swipe gestures
            let startX;
            document.addEventListener('touchstart', e => startX = e.touches[0].clientX);
            document.addEventListener('touchend', e => {
                let endX = e.changedTouches[0].clientX;
                if (startX - endX > 100) {
                    nav.classList.remove('show');
                    content.classList.add('shift');
                } else if (endX - startX > 100) {
                    nav.classList.add('show');
                    content.classList.remove('shift');
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
			let startY;
			let lastScrollTop = 0;
			let isHeaderHidden = document.body.classList.contains('header-hidden');

			// Toggle the header visibility
			function toggleHeader(show) {
				document.body.classList.toggle('header-hidden', !show);
				isHeaderHidden = !show;
			}

			// Detect swipe gestures
			window.addEventListener('touchstart', (e) => {
				startY = e.touches[0].clientY;
			});

			window.addEventListener('touchmove', (e) => {
				if (!window.SUPPORTER || !window.SELECTED_CHAPTER) return;
				
				const moveY = e.touches[0].clientY;
				const diffY = startY - moveY;

				if (diffY > 50 && !isHeaderHidden) {
					// Swipe up: Hide header
					toggleHeader(false);
				} else if (diffY < -50 && isHeaderHidden) {
					// Swipe down: Show header
					toggleHeader(true);
				}
			});

			// Detect scroll events
			window.addEventListener('scroll', () => {
				if (!window.SUPPORTER || !window.SELECTED_CHAPTER) return;

				const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;

				if (currentScrollTop > lastScrollTop && !isHeaderHidden) {
					// Scrolling down: Hide header
					toggleHeader(false);
				} else if (currentScrollTop < lastScrollTop && isHeaderHidden) {
					// Scrolling up: Show header
					toggleHeader(true);
				}

				lastScrollTop = Math.max(currentScrollTop, 0); // Ensure the value doesn't go below 0
			});
        });
	</script>
	<script>
        document.addEventListener('DOMContentLoaded', function () {
            // Patreon login/logout
            const CLIENT_ID = 'DCmpYjAt5oF-1poN2N_hW22VXTuz8BNIOPk1yeoctffuvobAJCu8I7N7fKc1ngMp';
            const REDIRECT_URI = "https://benis-boy.github.io/SSJ/";
            const PATREON_OAUTH_URL = `https://www.patreon.com/oauth2/authorize?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&scope=identity%20identity.memberships`;

            const patreonLoginButton = document.getElementById('patreon-login');
            const patreonLogoutButton = document.getElementById('patreon-logout');
            const patreonUsernameSpan = document.getElementById('patreon-username');

            function showPatreonUser(username) {
                patreonLoginButton.style.display = 'none';
                patreonLogoutButton.style.display = 'block';
                patreonUsernameSpan.textContent = `Logged in as ${username}`;
                patreonUsernameSpan.style.display = 'block';
            }

            async function checkPatreonAuthentication() {
                const token = JSON.parse(localStorage.getItem('patreon_token'));

                if (!token) {
                    patreonLoginButton.style.display = 'block';
                    patreonLogoutButton.style.display = 'none';
                    patreonUsernameSpan.style.display = 'none';
					loadContent('not_logged_in.html');
                    return;
                }

                const username = token?.userInfo?.userName;
                if (username) showPatreonUser(username);
				
				window.SUPPORTER = token?.userInfo?.supportsMe;
                
				if (username && !window.SUPPORTER) loadContent('not_a_supporter.html');
				if (username && window.SUPPORTER) loadContent('homepage.html');
				if (!username) loadContent('not_logged_in.html');
            }

            patreonLoginButton.addEventListener('click', () => window.location.href = PATREON_OAUTH_URL);
            patreonLogoutButton.addEventListener('click', () => {
                localStorage.removeItem('patreon_token');
                checkPatreonAuthentication();
            });

			const url = new URL(window.location);
            const urlParams = new URLSearchParams(url.search);
            const authCode = urlParams.get('code');
            if (authCode) handlePatreonAuth({ code: authCode });

            async function handlePatreonAuth(auth) {
                const response = await fetch('https://mellow-kitsune-6578b2.netlify.app/.netlify/functions/patreon-oauth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(auth),
                });
                const data = await response.json();
                if (data) {
                    localStorage.setItem("patreon_token", JSON.stringify(data));
                    checkPatreonAuthentication();
                } else {
                    console.error('Error:', data);
                }
				urlParams.delete("code");
				urlParams.delete("state");
				window.history.replaceState({}, document.title, `${url.pathname}?${urlParams.toString()}`);
            }

            checkPatreonAuthentication();
        });
    </script>
</head>
<body>
    <div id="header-bar">
        <button id="toggleNav">☰</button>
        <h1 id="bookTitle">Pokemon - Solo's Strange Journey</h1>
        <div id="patreon-section">
            <button id="patreon-login">Login with Patreon</button>
            <span id="patreon-username" style="display: none;"></span>
            <button id="patreon-logout" style="display: none;">Logout</button>
        </div>
    </div>

    <div id="book">
        <ul id="navigation" class="show">
		
        </ul>
        <div id="content">
            <p>Select a chapter.</p>
        </div>
    </div>
</body>
</html>
